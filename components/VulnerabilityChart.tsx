import React from 'react';
import { Device, Severity } from '../types';

// The global Recharts object might not be available at module load time.
// We'll access it inside the component to ensure the script has loaded.

interface VulnerabilityChartProps {
    devices: Device[];
}

const COLORS: Record<Severity, string> = {
    [Severity.High]: '#ef4444', // red-500
    [Severity.Medium]: '#f59e0b', // amber-500
    [Severity.Low]: '#22c55e', // green-500
};

export const VulnerabilityChart: React.FC<VulnerabilityChartProps> = ({ devices }) => {
    // Access Recharts from the window object here, inside the component render function.
    // This prevents a race condition on module load.
    const Recharts = (window as any).Recharts;
    
    // If Recharts hasn't loaded yet, render a placeholder.
    if (!Recharts) {
        return (
            <div style={{ width: '100%', height: 250 }} className="mt-6 flex items-center justify-center text-brand-text-secondary">
                Loading Chart...
            </div>
        );
    }
    const { PieChart, Pie, Cell, Tooltip, ResponsiveContainer, Legend } = Recharts;

    const riskData = devices.reduce((acc, device) => {
        const existing = acc.find(item => item.name === device.risk);
        if (existing) {
            existing.value += 1;
        } else {
            acc.push({ name: device.risk, value: 1 });
        }
        return acc;
    }, [] as { name: Severity; value: number }[]).sort((a,b) => {
        const order = { High: 0, Medium: 1, Low: 2 };
        return order[a.name] - order[b.name];
    });

    if (devices.length === 0) {
        return null;
    }

    return (
        <div style={{ width: '100%', height: 250 }} className="mt-6">
            <ResponsiveContainer>
                <PieChart>
                    <Pie
                        data={riskData}
                        cx="50%"
                        cy="50%"
                        labelLine={false}
                        outerRadius={80}
                        fill="#8884d8"
                        dataKey="value"
                        nameKey="name"
                    >
                        {riskData.map((entry) => (
                            <Cell key={`cell-${entry.name}`} fill={COLORS[entry.name]} />
                        ))}
                    </Pie>
                    <Tooltip
                        contentStyle={{
                            background: '#161B22', // brand-surface
                            border: '1px solid #30363D', // brand-border
                            borderRadius: '0.5rem'
                        }}
                    />
                    <Legend />
                </PieChart>
            </ResponsiveContainer>
        </div>
    );
};
